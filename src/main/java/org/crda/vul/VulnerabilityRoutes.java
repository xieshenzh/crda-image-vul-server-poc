package org.crda.vul;

import jakarta.enterprise.context.ApplicationScoped;
import org.apache.camel.builder.AggregationStrategies;
import org.apache.camel.builder.RouteBuilder;
import org.apache.camel.processor.aggregate.GroupedBodyAggregationStrategy;
import org.crda.vul.exhort.AnalysisReportAggregationStrategy;

import static org.apache.camel.builder.endpoint.StaticEndpointBuilders.direct;

@ApplicationScoped
public class VulnerabilityRoutes extends RouteBuilder {

    @Override
    public void configure() throws Exception {
        from(direct("getVuls"))
                .to(direct("getSBOMs"))
                .to(direct("getVulDataForImages"));

        from(direct("getVulDataForImages"))
                .choice()
                .when(body().isNotNull())
                .split(body(), new GroupedBodyAggregationStrategy())
                .stopOnException()
                .parallelProcessing()
                .to(direct("getVulDataForSingleImage"))
                .end()
                .endChoice();

        from(direct("getVulDataForSingleImage"))
                .to(direct("splitSBOM"))
                .split(body(), AggregationStrategies.beanAllowNull(AnalysisReportAggregationStrategy.class, "aggregate"))
                .stopOnException()
                .parallelProcessing()
                .to(direct("convertSBOMToPayload"))
                .choice()
                .when(body().isNotNull())
                .to(direct("exhortAnalysis"))
                .endChoice()
                .end();
    }
}
